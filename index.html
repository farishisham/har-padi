<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Lot Kerja Har Padi Ent.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; background:black; }
    #map { width:100%; height:100%; }
    #header, #footer {
      position:fixed; width:100%; background:rgba(0,0,0,0.5);
      color:white; font-family:Helvetica,sans-serif; z-index:1000;
    }
    #header { top:0; padding:6px 0; text-align:center; }
    #header h1 { margin:0; font-size:1rem; }
    #footer {
      bottom:0; font-size:0.6rem; padding:5px 10px;
      text-align:left; background:transparent;
    }

    #gpsButton {
      position:fixed; bottom:35px; right:15px;
      width:44px; height:44px; background:#333;
      border:none; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; z-index:1001;
    }
    #gpsIconImg { width:20px; height:20px; }

    .gps-marker {
      position:relative; width:30px; height:30px;
    }
    .gps-marker .circle {
      width:13px; height:13px; background:#007BFF;
      border:1px solid white; border-radius:50%;
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%); z-index:2;
    }
    .gps-marker .triangle {
      position:absolute; top:0; left:50%;
      transform:translateX(-50%);
      width:0; height:0;
      border-left:7px solid transparent;
      border-right:7px solid transparent;
      border-bottom:13px solid white;
      z-index:1;
    }

    .popup-no-x .maplibregl-popup-close-button { display:none; }

    .search-container {
      position:absolute; top:44px; right:15px; height:48px; z-index:1003;
    }
    .search-btn, .close-btn {
      position:absolute; right:0; z-index:1002;
      width:44px; height:44px; padding:0;
      border:none; border-radius:50%;
      background:#333; display:flex;
      align-items:center; justify-content:center;
      cursor:pointer;
    }
    .search-btn svg, .close-btn svg { width:18px; height:18px; fill:white; }
    .search-input {
      position:absolute; right:0; z-index:1001;
      width:0; opacity:0; height:38px; top:-2px;
      transform:translateX(2px); padding-left:10px;
      padding-right:50px; border-radius:30px;
      border:1px solid #ccc; background:white;
      font-family:Helvetica; outline:none; transition:all .3s ease;
    }
    .search-container.active .search-input {
      width:200px; opacity:1;
    }
    .search-container.active .search-btn { display:none; }
    .search-container.active .close-btn { display:flex; }
    .close-btn { display:none; }

    #suggestions {
      position:absolute;
      top:46px;
      right:83px;
      width:190px;
      background:white;
      border-radius:5px;
      box-shadow:0 2px 5px rgba(0,0,0,0.3);
      z-index:1000;
      max-height:180px;
      overflow-y:auto;
      font-family:Helvetica;
      font-size:13px;
    }

    #suggestions div {
      padding:6px 10px;
      border-bottom:1px solid #ccc;
      cursor:pointer;
    }

    #suggestions div:hover {
      background:#f0f0f0;
    }
  </style>
</head>
<body>

<div id="header">
  <h1>LOT KERJA HAR PADI ENT. (in progress)</h1>
</div>

<div id="map"></div>

<div id="footer">Â© 2025 Hisham</div>

<button id="gpsButton" title="Toggle GPS Mode">
  <img id="gpsIconImg"
       src="https://www.svgrepo.com/download/421169/gps-navigation-position.svg"
       alt="GPS"/>
</button>

<div class="search-container" id="searchContainer">
  <input type="text" class="search-input" id="searchInput" placeholder="Cari...">
  <button class="search-btn" id="searchBtn" title="Search">
    <svg viewBox="0 0 24 24"><path d="M21.707 20.293l-5.388-5.388A7.935 7.935 0 0018 10a8 8 0 10-8 8 7.935 7.935 0 004.905-1.681l5.388 5.388a1 1 0 001.414-1.414zM4 10a6 6 0 1112 0 6 6 0 01-12 0z"/></svg>
  </button>
  <button class="close-btn" id="closeBtn" title="Tutup">
    <svg viewBox="0 0 24 24"><path d="M18.364 5.636a1 1 0 00-1.414 0L12 10.586 7.05 5.636a1 1 0 00-1.414 1.414L10.586 12l-4.95 4.95a1 1 0 101.414 1.414L12 13.414l4.95 4.95a1 1 0 001.414-1.414L13.414 12l4.95-4.95a1 1 0 000-1.414z"/></svg>
  </button>
</div>
<div id="suggestions" style="display:none"></div>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>
const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      'esri-satellite': {
        type: 'raster',
        tiles: ['https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
        tileSize: 256
      }
    },
    layers: [{
      id: 'esri-layer',
      type: 'raster',
      source: 'esri-satellite'
    }]
  },
  center: [102.68379, 2.23708],
  zoom: 13,
  minZoom: 13,
  maxZoom: 17.4
});

const allFeatures = [];
const sourceFiles = [
  { id: 'sawahring', url: 'sawahring.json' },
  { id: 'blok5', url: 'blok5.json' }
];

map.on('load', async () => {
  map.dragPan.enable();
  map.scrollZoom.enable();
  map.touchZoomRotate.enable();

  for (const src of sourceFiles) {
    const res = await fetch(src.url);
    const geo = await res.json();

    geo.features.forEach(f => f.properties._src = src.id);
    allFeatures.push(...geo.features);

    map.addSource(src.id, { type: 'geojson', data: geo });

    map.addLayer({
      id: `${src.id}-fill`,
      type: 'fill',
      source: src.id,
      paint: {
        'fill-color': ['coalesce', ['get', 'fill'], '#00cc66'],
        'fill-opacity': 0.4
      }
    });

    map.addLayer({
      id: `${src.id}-outline`,
      type: 'line',
      source: src.id,
      paint: { 'line-color': '#004d26', 'line-width': 2 }
    });
  }

  map.addSource('highlight', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });

  map.addLayer({
    id: 'highlight',
    type: 'line',
    source: 'highlight',
    paint: { 'line-color': '#ffcc00', 'line-width': 4 }
  });
});

function highlightFeature(feature) {
  map.getSource('highlight').setData(feature);
  const bounds = turf.bbox(feature);
  const center = turf.center(feature).geometry.coordinates;
  map.fitBounds([[bounds[0], bounds[1]], [bounds[2], bounds[3]]], {
    padding: 100,
    maxZoom: 17.4,
    bearing: map.getBearing()
  });
  document.querySelectorAll('.maplibregl-popup').forEach(p => p.remove());
  new maplibregl.Popup({ closeButton: false })
    .setLngLat(center)
    .setHTML(`<strong>${feature.properties.name}</strong>`)
    .addTo(map)
    .getElement().classList.add('popup-no-x');
}

document.getElementById("searchBtn").addEventListener("click", () => {
  document.getElementById("searchContainer").classList.add("active");
  document.getElementById("searchInput").focus();
});

document.getElementById("closeBtn").addEventListener("click", () => {
  document.getElementById("searchContainer").classList.remove("active");
  document.getElementById("searchInput").value = '';
  document.getElementById("suggestions").style.display = 'none';
});

document.getElementById("searchInput").addEventListener("input", e => {
  const val = e.target.value.trim().toLowerCase();
  const matches = val
    ? allFeatures.filter(f => f.properties.name.toLowerCase().includes(val))
    : [];

  const suggestions = document.getElementById("suggestions");
  suggestions.innerHTML = '';
  if (matches.length > 0) {
    matches.forEach(f => {
      const div = document.createElement('div');
      div.textContent = f.properties.name;
      div.addEventListener('click', () => {
        highlightFeature(f);
        suggestions.style.display = 'none';
      });
      suggestions.appendChild(div);
    });
    suggestions.style.display = 'block';
  } else {
    suggestions.style.display = 'none';
  }
});
</script>
</body>
</html>
