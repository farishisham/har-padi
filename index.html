<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lot Kerja Har Padi Enterprise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="apple-touch-icon" sizes="180x180" href="harpadi.png">
  <link rel="icon" href="favicon.png" type="image/png">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
  
    html, body { margin:0; padding:0; height:100%;width:100%; background:black;}
    #map { width:100%; height:100%; }
    
    #header, #footer {
      position:fixed; width:100%; background:transparent;
      color:white; font-family:Helvetica,sans-serif;
      text-align:center; z-index:1000; text-shadow: 1px 1px 0 black;touch-action: none;
    }
    #header { top:0; padding:5px 0; touch-action: none;}
    #header h1 { margin:0; font-size:0.9rem; }
    #footer {
      bottom:0; font-size:0.6rem;
      left:3%;
      padding:5px 10px; text-align:left;
      background:transparent;touch-action: none;
    }

    #gpsButton {
      position:fixed; bottom:35px; right:15px;
      width:44px; height:44px; background:#333;
      border:none; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; z-index:1001;touch-action: none;
    }
    #gpsIconImg { width:20px; height:20px; touch-action: none;}

    .gps-marker {
      position:relative; width:30px; height:30px;touch-action: none;
    }
    .gps-marker .circle {
      width:13px; height:13px; background:#007BFF;
      border:1px solid white; border-radius:50%;
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%); z-index:2;
    }
    .gps-marker .triangle {
      position:absolute; top:0; left:50%;
      transform:translateX(-50%);
      width:0; height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-bottom:11px solid white;
      z-index:1;
    }

    .popup-no-x .maplibregl-popup-close-button { display:none; }

    .search-container {
      position:absolute; top:44px; right:15px;
      height:48px; z-index:1003;
    }
    .search-btn, .close-btn {
      position:absolute; right:0; z-index:1002;touch-action: none;
      width:44px;height:44px;padding:0;
      border:none;border-radius:50%;
      background:#333;display:flex;
      align-items:center;justify-content:center;
      cursor:pointer;top: 50%;  /* Vertically center the button */
      transform: translateY(-50%); /* Adjust the button's position to center it */

    }
    .search-btn svg, .close-btn svg { width:18px;height:18px;fill:white; touch-action: none;}
    .search-input {
      position:absolute; right:0; z-index:1001;
      width:0; opacity:0; height:41px; 
      top: 50%;  /* Vertically center the input */
      transform: translateY(-50%) translateX(2px);  /* Adjust input to center it vertically */ padding-left:10px;
      padding-right:50px; border-radius:30px;
      border:1px solid #ccc; background:white;
      outline:none; transition:all .3s ease;touch-action: none;
    }
    .search-container.active .search-input {
      width:250px; opacity:1;touch-action: none;
    }
    .search-container.active .search-btn { display:none; touch-action: none;}
    .search-container.active .close-btn { display:flex; touch-action: none;}
    .close-btn { display:none; touch-action: none;}

    #suggestions {
      position: absolute;
      top: 55px;
      right: 70px;
      width: 240px;
      max-height: 150px;
      overflow-y: auto;
      background: white;
      border-radius: 5px;
      font-family: Helvetica, sans-serif;
      font-size: 13px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 1002;touch-action: auto;
    }
    
    #suggestions div {
      padding: 5px 10px;
      cursor: pointer;
    }
    
    #suggestions div:hover {
      background: #eee;touch-action: auto;
    }

    #gpsMessage {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 8px 15px;
      border-radius: 6px;
      font-family: Helvetica, sans-serif;
      font-size: 13px;
      z-index: 9999;
      display: none;touch-action: none;
    }
    
    button:focus { outline: none; touch-action: none;}
  
  </style>
</head>
<body>

<div id="header">
  <h1>LOT KERJA HAR PADI ENTERPRISE</h1>
</div>

<div id="map"></div>

<div id="footer">© 2025 Hisham</div>

<div id="gpsMessage">Anda berada di luar kawasan..</div>

<button id="gpsButton" title="Toggle GPS Mode">
  <img id="gpsIconImg"
       src="https://www.svgrepo.com/download/421169/gps-navigation-position.svg"
       alt="GPS"/>
</button>

<div class="search-container" id="searchContainer">
  <input type="text" class="search-input" id="searchInput" placeholder="Cari...">
  <div id="suggestions"></div>
  <button class="search-btn" id="searchBtn" title="Search">
    <svg viewBox="0 0 24 24"><path d="M21.707 20.293l-5.388-5.388A7.935 7.935 0 0018 10a8 8 0 10-8 8 7.935 7.935 0 004.905-1.681l5.388 5.388a1 1 0 001.414-1.414zM4 10a6 6 0 1112 0 6 6 0 01-12 0z"/></svg>
  </button>
  <button class="close-btn" id="closeBtn" title="Tutup">
    <svg viewBox="0 0 24 24"><path d="M18.364 5.636a1 1 0 00-1.414 0L12 10.586 7.05 5.636a1 1 0 00-1.414 1.414L10.586 12l-4.95 4.95a1 1 0 101.414 1.414L12 13.414l4.95 4.95a1 1 0 001.414-1.414L13.414 12l4.95-4.95a1 1 0 000-1.414z"/></svg>
  </button>
</div>

<div id="tuaiLegend" style="
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background:#333;
  padding: 8px 12px;
  border-radius: 5px;
  color: white;
  font-family: Helvetica, sans-serif;
  font-size: 12px;
  z-index: 1002;
  display: none;
  pointer-events: none;
">
  <div><span style="background:#00cc00;display:inline-block;width:12px;height:12px;margin-right:6px;"></span>Belum masak</div>
  <div><span style="background:#b5a300;display:inline-block;width:12px;height:12px;margin-right:6px;"></span>Masak</div>
  <div><span style="background:#802600;display:inline-block;width:12px;height:12px;margin-right:6px;"></span>Rentung</div>
</div>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      'esri-satellite': {
        type: 'raster',
        tiles: [
          'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
        ],
        tileSize: 256
      }
    },
    layers: [{
      id: 'esri-layer',
      type: 'raster',
      source: 'esri-satellite'
    }]
  },
  center: [102.68379, 2.23708],
  zoom: 13,
  minZoom: 13,
  maxZoom: 17.4
});

// Limit map bounds
map.setMaxBounds([[102.66830, 2.21776], [102.69816, 2.25551]]);
const boundsPolygon = turf.bboxPolygon([102.66830, 2.21776, 102.69816, 2.25551]);

// GPS and Marker
let gpsMode = 1, watchId = null, marker = null;
const iconImg = document.getElementById('gpsIconImg');
const gpsMsg = document.getElementById('gpsMessage');

// FUNCTIONS
function setIconColor() {
  iconImg.style.filter =
    gpsMode === 1 ? 'invert(100%)' :
    gpsMode === 2 ? 'invert(67%) sepia(92%) saturate(455%) hue-rotate(81deg)' :
                    'invert(45%) sepia(100%) saturate(3000%) hue-rotate(5deg)';
}

function showGPSMessage() {
  gpsMsg.style.display = 'block';
  setTimeout(() => gpsMsg.style.display = 'none', 3000);
}

function createMarker(lng, lat) {
  const el = document.createElement('div');
  el.className = 'gps-marker';
  el.innerHTML = '<div class="triangle"></div><div class="circle"></div>';
  marker = new maplibregl.Marker(el).setLngLat([lng, lat]).addTo(map);
}

function updateMarker(lng, lat) {
  if (marker) {
    marker.setLngLat([lng, lat]);
  } else {
    createMarker(lng, lat);
  }
  if (gpsMode === 3) map.setCenter([lng, lat]);
}

function rotateMap(event) {
  if (gpsMode !== 3) return;
  const heading = event.webkitCompassHeading ?? (360 - event.alpha);
  if (heading !== null && !isNaN(heading)) {
    map.rotateTo(heading, { duration: 100 });
  }
}

function handleOrientation() {
  if (DeviceOrientationEvent.requestPermission) {
    DeviceOrientationEvent.requestPermission().then(granted => {
      if (granted === 'granted') window.addEventListener('deviceorientation', rotateMap, true);
    });
  } else {
    window.addEventListener('deviceorientation', rotateMap, true);
  }
}

// GPS Button Click
document.getElementById('gpsButton').addEventListener('click', () => {
  gpsMode = (gpsMode % 3) + 1;
  setIconColor();
  if (watchId) navigator.geolocation.clearWatch(watchId);
  watchId = null;
  window.removeEventListener('deviceorientation', rotateMap);

  if (gpsMode === 1) return;

  watchId = navigator.geolocation.watchPosition(pos => {
    const [lng, lat] = [pos.coords.longitude, pos.coords.latitude];
    const point = turf.point([lng, lat]);
    if (!turf.booleanPointInPolygon(point, boundsPolygon)) {
      gpsMode = 1;
      setIconColor();
      showGPSMessage();
      if (watchId) navigator.geolocation.clearWatch(watchId);
      watchId = null;
      return;
    }
    updateMarker(lng, lat);
    if (gpsMode === 2) map.setCenter([lng, lat]);
  }, null, { enableHighAccuracy: true });

  if (gpsMode === 3) handleOrientation();
});

// Cancel GPS mode when user interacts
map.on('dragstart', () => {
  if (gpsMode !== 1) {
    gpsMode = 1;
    setIconColor();
    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = null;
    window.removeEventListener('deviceorientation', rotateMap);
  }
});
map.on('touchstart', () => {
  if (gpsMode !== 1) {
    gpsMode = 1;
    setIconColor();
    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = null;
    window.removeEventListener('deviceorientation', rotateMap);
  }
});

// --- POLYGONS ---

const groups = {
  sawahring: 'sawahring.json',
  blok: [
    'blok1.json'
  ]
};

let allFeatures = [];

let activeWordFilter = null;

map.on('load', async ()=> {
  map.dragPan.enable();
  map.scrollZoom.enable();
  map.touchZoomRotate.enable();

  await loadGroup('sawahring', ['sawahring.json']);  // Always load sawahring first
  await loadGroup('blok', [
    'blok1.json'
  ]);
});

async function loadGroup(group, files) {
  for (const filename of files) {
    const response = await fetch(filename);
    const data = await response.json();
    const sourceId = `${group}-${filename}`;

    data.features.forEach((f, i) => f.properties._id = `${group}-${filename}-${i}`);
    allFeatures.push(...data.features);

    map.addSource(sourceId, { type: 'geojson', data });

    const baseOpacity = group === 'sawahring' ? 0.4 : 0;

    map.addLayer({
      id: `${sourceId}-fill`,
      type: 'fill',
      source: sourceId,
      paint: {
        'fill-color': ['get', 'fill'],
        
        'fill-opacity': [
          'interpolate', ['linear'], ['zoom'],
          13, baseOpacity,
          14, baseOpacity,
          15, baseOpacity === 0.4 ? 0.2 : 0.2,
          16, baseOpacity === 0.4 ? 0 : 0.4
        ]
      }
    });

    map.addLayer({
      id: `${sourceId}-line`,
      type: 'line',
      source: sourceId,
      paint: {
        'line-color': '#004d26',
        'line-opacity': [
          'interpolate', ['linear'], ['zoom'],
          13, baseOpacity,
          14, baseOpacity,
          15, baseOpacity === 1 ? 1 : 1,
          16, baseOpacity === 1 ? 0 : 1
        ],
        'line-width': 2
      }
    });

    map.addLayer({
      id: `${sourceId}-highlight`,
      type: 'line',
      source: sourceId,
      paint: {
        'line-color': '#ffcc00',
        'line-width': 4
      },
      filter: ['==', '_id', '']
    });

    map.on('click', `${sourceId}-fill`, e => {
  const zoom = map.getZoom();

  // Only allow clicks on 'blok' at zoom ≥ 15
  if (group === 'blok' && zoom >= 15) {
    const f = e.features[0];
    highlightFeature(f);
  }

  // Only allow clicks on 'sawahring' at zoom < 15
  if (group === 'sawahring' && zoom < 15) {
    const f = e.features[0];
    highlightFeature(f);
  }

  // Otherwise, ignore the click
});
  }
}

function parseTarikhTanam(f) {
  const rawHTML = f.properties?.description?.value || '';
  const parser = new DOMParser();
  const doc = parser.parseFromString(rawHTML, 'text/html');
  const text = doc.body.textContent.toLowerCase().replace(/\s+/g, ' ').trim();

  const match = text.match(/tarikh tanam\s+(\d{1,2}\/\d{1,2}\/\d{4})/);
  if (!match) return 'Tiada';

  const [day, month, year] = match[1].split('/').map(Number);
  const formattedDay = day.toString().padStart(2, '0');
  const formattedMonth = month.toString().padStart(2, '0');
  return `${formattedDay}/${formattedMonth}/${year}`;
}

function parseTaburInfo(f) {
  const rawHTML = f.properties?.description?.value || '';
  const parser = new DOMParser();
  const doc = parser.parseFromString(rawHTML, 'text/html');
  const text = doc.body.textContent.toLowerCase();

  // Match "tabur" followed by number + "beg", e.g., "tabur 2 beg"
  const match = text.match(/tabur\s+\d+\s+beg/i);
  return match
  ? match[0].charAt(0).toUpperCase() + match[0].slice(1)
  : null;
}

function parseBenihType(f) {
  const rawHTML = f.properties?.description?.value || '';
  const parser = new DOMParser();
  const doc = parser.parseFromString(rawHTML, 'text/html');
  const text = doc.body.textContent.toLowerCase().replace(/\s+/g, ' ').trim();

  // Match the word after "benih", stopping before "tarikh" if present
  const match = text.match(/benih\s+(.+?)(?=\s+tarikh|$)/i);
  return match ? match[1].trim().toUpperCase() : null;
}

function getDaysSinceTanam(tarikhStr) {
  if (!tarikhStr) return null;

  // Expecting format "dd/mm/yyyy"
  const [day, month, year] = tarikhStr.split('/').map(Number);
  const tanamDate = new Date(year, month - 1, day);
  const today = new Date();

  const diffTime = today - tanamDate; // in milliseconds
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

  return diffDays;
}

function formatUsiaBenih(tarikhStr) {
  const days = getDaysSinceTanam(tarikhStr);
  return days !== null ? `${days}` : '';
}

function highlightFeature(fPartial) {
  // Find full feature by _id
  const f = allFeatures.find(feat => feat.properties._id === fPartial.properties._id);
  if (!f) {
    console.warn('Full feature not found!');
    return;
  }

  // Apply highlight filter
  Object.entries(groups).forEach(([group, files]) => {
    (Array.isArray(files) ? files : [files]).forEach(file => {
      const id = `${group}-${file}`;
      const filter = f.properties._id.startsWith(id)
        ? ['==', '_id', f.properties._id]
        : ['==', '_id', ''];
      map.setFilter(`${id}-highlight`, filter);
    });
  });

  // Remove any existing popups
  document.querySelectorAll('.maplibregl-popup').forEach(p => p.remove());
  gpsMode = 1;
  setIconColor();

  const center = turf.center(f).geometry.coordinates;
  map.fitBounds(turf.bbox(f), {
    padding: 100,
    maxZoom: 17.4,
    bearing: map.getBearing()
  });

  const area = (turf.area(f) / 4046.86).toFixed(2);
  const areahectare = (turf.area(f)*0.405 / 4046.86).toFixed(2);
  const isBlok = !f.properties.name?.toLowerCase().includes('blok'); // Adjust logic if needed

  let popupHTML = `
    <strong>${f.properties.name}</strong><br>
    ${area} ekar atau ${areahectare} hektar
  `;

  if (isBlok) {
    const benih = parseBenihType(f);
    const tabur = parseTaburInfo(f);
    const tray = Math.round(area * 35);
    const tarikhTanam = parseTarikhTanam(f);
    const usiaText = formatUsiaBenih(tarikhTanam);
//console.log(days); // e.g. → 16 (if today is 18 May 2025)
    popupHTML += `<br>Benih: ${benih || 'Tiada'}`;
    
    if (tabur) popupHTML += `<br>${tabur}`;
    //if (benih) popupHTML += `<br>Benih: ${benih}`
    if (f.properties.description?.value?.toLowerCase().includes('calit')) popupHTML += `<br>${tray} tray atau ${tray*3} gulung<br>Tarikh tanam: ${tarikhTanam}<br>Usia benih: ${usiaText} hari`;
  }

  new maplibregl.Popup({ closeButton: false })
    .setLngLat(center)
    .setHTML(popupHTML)
    .addTo(map)
    .getElement().classList.add('popup-no-x');
}


// Clear highlight when clicking empty area
map.on('click', e => {
  const allLayers = [];
  Object.entries(groups).forEach(([g, files]) => {
    (Array.isArray(files) ? files : [files]).forEach(f => {
      allLayers.push(`${g}-${f}-fill`);
    });
  });
  const f = map.queryRenderedFeatures(e.point, { layers: allLayers })[0];
  if (!f) {
    Object.entries(groups).forEach(([g, files]) => {
      (Array.isArray(files) ? files : [files]).forEach(file => {
        map.setFilter(`${g}-${file}-highlight`, ['==', '_id', '']);
      });
    });
    document.querySelectorAll('.maplibregl-popup').forEach(p => p.remove());
  }
});

// --- SEARCH ---
const input = document.getElementById('searchInput');
const container = document.getElementById('searchContainer');
const suggestions = document.getElementById('suggestions');

input.addEventListener('input', () => {
  const q = input.value.trim().toLowerCase();
  suggestions.innerHTML = '';
  if (!q) return;
  const matches = allFeatures.filter(f => f.properties.name?.toLowerCase().includes(q));
  matches.forEach(f => {
    const div = document.createElement('div');
    div.textContent = f.properties.name;
    div.addEventListener('click', () => {
      input.value = '';
      container.classList.remove('active');
      suggestions.innerHTML = '';
      highlightFeature(f);
    });
    suggestions.appendChild(div);
  });
});

document.getElementById('searchBtn').addEventListener('click', () => {
  container.classList.add('active');
  input.focus();
});

document.getElementById('closeBtn').addEventListener('click', () => {
  container.classList.remove('active');
  input.value = '';
  suggestions.innerHTML = '';
});

// Close search when tapping outside
map.getCanvas().addEventListener('click', () => {
  container.classList.remove('active');
  input.value = '';
  suggestions.innerHTML = '';
});

// --- FILTER BUTTONS ---
// Setup filter buttons
const filterContainer = document.createElement('div');
filterContainer.style.position = 'absolute';
filterContainer.style.top = '100px';
filterContainer.style.right = '15px';
filterContainer.style.display = 'flex';
filterContainer.style.flexDirection = 'column';
filterContainer.style.gap = '8px';
filterContainer.style.touchAction= 'none';
filterContainer.style.zIndex = 1004;
document.body.appendChild(filterContainer);

function createFilterButton(label, id) {
  const btn = document.createElement('button');
  btn.textContent = label;
  btn.id = id;
  btn.style.width = '44px';
  btn.style.height = '44px';
  btn.style.borderRadius = '50%';
  btn.style.border = 'none';
  btn.style.background = '#333';
  btn.style.color = 'white';
  btn.style.fontSize = '11px';
  btn.style.cursor = 'pointer';
  btn.style.display = 'flex';
  btn.style.alignItems = 'center';
  btn.style.justifyContent = 'center';
  btn.style.userSelect = 'none';
  btn.style.transition = 'color 0.3s ease, background 0.3s ease'; // Smooth animation
  return btn;
}

const bajakBtn = createFilterButton('Bajak', 'bajakFilter');
const calitBtn = createFilterButton('Calit', 'calitFilter');
const racunBtn = createFilterButton('Racun', 'racunFilter');

const tuaiBtn = document.createElement('button');
tuaiBtn.textContent = 'Tuai';
tuaiBtn.style.position = 'fixed';
tuaiBtn.style.display = 'flex';
tuaiBtn.style.alignItems = 'center';
tuaiBtn.style.justifyContent = 'center';
tuaiBtn.style.bottom = '35px';
tuaiBtn.style.left = '15px';
tuaiBtn.style.width = '44px';
tuaiBtn.style.height = '44px';
tuaiBtn.style.borderRadius = '50%';
tuaiBtn.style.border = 'none';
tuaiBtn.style.background = '#333';
tuaiBtn.style.color = 'white';
tuaiBtn.style.fontSize = '13px';
tuaiBtn.style.cursor = 'pointer';
tuaiBtn.style.zIndex = 1001;
document.body.appendChild(tuaiBtn);

const benihRipenessDays = {
  'cl': 100,
  '269': 120,
  'hybrid': 110
};

filterContainer.appendChild(tuaiBtn);
filterContainer.appendChild(bajakBtn);
filterContainer.appendChild(calitBtn);
filterContainer.appendChild(racunBtn);

// Create and style the "Tuai" button (bottom left)
//const tuaiBtn = document.createElement('button');

function extractDescriptionText(f) {
  const rawHTML = f.properties?.description?.value || f.properties?.description || '';
  const parser = new DOMParser();
  const doc = parser.parseFromString(rawHTML, 'text/html');
  return doc.body.textContent?.toLowerCase() || '';
}

function calculateRipenessPercent(plantingDate, ripeDay) {
  const today = new Date();
  const planted = new Date(plantingDate);
  const daysSincePlanting = (today - planted) / (1000 * 60 * 60 * 24);

  if (daysSincePlanting < 0) return 0; // Future planting

  const ripeStart = ripeDay;
  const ripeEnd = ripeDay + 10;

  if (daysSincePlanting < ripeStart) {
    return daysSincePlanting / ripeDay; // 0 to 1
  } else if (daysSincePlanting <= ripeEnd) {
    return 1; // Fully ripe for 10 days
  } else {
    const overripeDays = daysSincePlanting - ripeEnd;
    return 1 + Math.min(overripeDays / 10, 0.25); // 1 to max 1.25
  }
}

function getRipenessLevel(tarikhTanam, benihType) {
  if (!tarikhTanam || !benihType) return null;
  
  const ripeDays = benihRipenessDays[benihType.toLowerCase()];
  if (!ripeDays) return null;

  const [d, m, y] = tarikhTanam.split('/').map(Number);
  const plantDate = new Date(y, m - 1, d);
  const now = new Date();
  const diffDays = Math.floor((now - plantDate) / (1000 * 60 * 60 * 24));

  return Math.max(0, Math.min(1, diffDays / ripeDays)); // clamp between 0–1
}

function getRipenessColor(days, ripeDays) {
  if (days < 0) return '#999999'; // future planting date
  if (days < ripeDays * 0.25) return '#00ff00';       // green
  if (days < ripeDays * 0.5) return '#aaff00';        // yellow-green
  if (days < ripeDays * 0.75) return '#ffff00';       // yellow
  if (days < ripeDays) return '#ffd700';              // gold (ripe)
  if (days < ripeDays + 10) return '#ff9900';         // dark gold (still okay)
  return '#802600';                                   // overripe
}

function updateTuaiOpacity(isActive) {
  Object.entries(groups).forEach(([group, files]) => {
    const isSawahRing = group === 'sawahring';
    const fileList = Array.isArray(files) ? files : [files];
    f.properties.fill = color;
    f.properties._visible = true; // optional if you're using _visible logic

    fileList.forEach(filename => {
      const sourceId = `${group}-${filename}`;
      const fillId = `${sourceId}-fill`;

      if (!map.getLayer(fillId)) return;

      if (isActive) {
        // Tuai ON: set fixed opacity
        map.setPaintProperty(fillId, 'fill-opacity', ['literal', 0.6]);

        if (isSawahRing) {
          const lineId = `${sourceId}-line`;
          if (map.getLayer(lineId)) {
            map.setPaintProperty(lineId, 'line-opacity', ['literal', 0.6]);
          }
        }
      } else {
        // Tuai OFF: restore zoom-based opacity
        const baseOpacity = isSawahRing ? 0.4 : 0;
        map.setPaintProperty(fillId, 'fill-opacity', [
          'interpolate', ['linear'], ['zoom'],
          13, baseOpacity,
          14, baseOpacity,
          15, baseOpacity === 0.4 ? 0.2 : 0.2,
          16, baseOpacity === 0.4 ? 0 : 0.4
        ]);

        if (isSawahRing) {
          const lineId = `${sourceId}-line`;
          if (map.getLayer(lineId)) {
            map.setPaintProperty(lineId, 'line-opacity', ['literal', 1]);
          }
        }
      }
    });
  });
}

let tuaiActive = false;

function toggleTuai() {
  tuaiActive = !tuaiActive;

  tuaiBtn.style.color = tuaiActive ? 'limegreen' : 'white';
  tuaiLegend.style.display = tuaiActive ? 'block' : 'none';

  Object.entries(groups).forEach(([group, files]) => {
    const isSawahRing = group === 'sawahring';
    const fileList = Array.isArray(files) ? files : [files];

    fileList.forEach(filename => {
      const sourceId = `${group}-${filename}`;
      const source = map.getSource(sourceId);
      if (!source || !source._data) return;

      const updatedFeatures = source._data.features.map(f => {
        const originalFill = f.properties.originalFill || f.properties.fill || '#ffffff';

        if (!tuaiActive) {
          return {
            ...f,
            properties: {
              ...f.properties,
              fill: originalFill
            }
          };
        }

        // TUAI ACTIVE
        const descText = extractDescriptionText(f);
        const benihMatch = descText.match(/benih\s+([^\s]+)/i);
        const benih = benihMatch ? benihMatch[1].toUpperCase() : null;

        const tarikhMatch = descText.match(/tarikh\s+tanam\s+(\d{1,2}\/\d{1,2}\/\d{4})/i);
        const tarikhStr = tarikhMatch ? tarikhMatch[1] : null;

        const ripeDaysMap = {
          'CL': 100,
          '269': 120,
          '467': 80,
          'MR297': 105,
          'HYBRID': 95
        };
        const ripeDays = ripeDaysMap[benih] || 110;

        let color = '#888';
        if (tarikhStr) {
          const [d, m, y] = tarikhStr.split('/').map(Number);
          const tanamDate = new Date(y, m - 1, d);
          const now = new Date();
          const diffDays = Math.floor((now - tanamDate) / (1000 * 60 * 60 * 24));
          color = getRipenessColor(diffDays, ripeDays);
        }

        return {
          ...f,
          properties: {
            ...f.properties,
            originalFill,
            fill: color
          }
        };
      });

      source.setData({
        type: 'FeatureCollection',
        features: updatedFeatures
      });

      const fillId = `${sourceId}-fill`;
      const lineId = `${sourceId}-line`;

      if (map.getLayer(fillId)) {
        map.setPaintProperty(fillId, 'fill-opacity',
          tuaiActive ? ['literal', 0.6] : [
            'interpolate', ['linear'], ['zoom'],
            13, isSawahRing ? 0.4 : 0,
            14, isSawahRing ? 0.4 : 0,
            15, isSawahRing ? 0.2 : 0.2,
            16, isSawahRing ? 0 : 0.4
          ]
        );
      }

      if (map.getLayer(lineId)) {
  if (tuaiActive) {
    map.setPaintProperty(lineId, 'line-opacity',
      isSawahRing ? ['literal', 0.6] : ['literal', 1]
    );
  } else {
    const baseOpacity = isSawahRing ? 1 : 1;
    map.setPaintProperty(lineId, 'line-opacity', [
      'interpolate', ['linear'], ['zoom'],
      13, baseOpacity,
      14, baseOpacity,
      15, baseOpacity,
      16, isSawahRing ? 0 : baseOpacity
    ]);
  }
}
    });
  });
}

//tuaiBtn.addEventListener('click', toggleTuai);

const tuaiLegend = document.getElementById('tuaiLegend');

tuaiBtn.addEventListener('click', toggleTuai);

let checkMarkers = [];

function clearCheckMarkers() {
  checkMarkers.forEach(m => m.remove());
  checkMarkers = [];
}

function showCheckmarks(keyword) {
  clearCheckMarkers();

  allFeatures.forEach(f => {
    const rawHTML = f.properties?.description?.value || '';
    const parser = new DOMParser();
    const doc = parser.parseFromString(rawHTML, 'text/html');
    const text = doc.body.textContent.toLowerCase();

    if (text.includes(keyword.toLowerCase())) {
      const center = turf.center(f).geometry.coordinates;
      
      const el = document.createElement('div');
      el.innerHTML = `
  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24">
    <path d="M18.047,4,22,8.325,9.3,20,2,12.68,6.136,8.533,9.474,11.88Z"
      fill="limegreen" />
    <path d="M18.047,4,22,8.325,9.3,20,2,12.68,6.136,8.533,9.474,11.88Z"
      fill="none" stroke="black" stroke-width="1.5"/>
  </svg>
`;
      el.style.transform = 'translate(-50%, -50%)';
      const marker = new maplibregl.Marker(el).setLngLat(center).addTo(map);
      checkMarkers.push(marker);
    }
  });
}


let activeKeyword = null;

function handleFilterClick(keyword, button) {
  const isSame = activeKeyword === keyword;

  // Always clear previous checkmarks and button highlights
  clearCheckMarkers();
  resetAllFilterButtons();

  if (!isSame) {
    activeKeyword = keyword;
    button.style.color = 'limegreen';
    showCheckmarks(keyword);
  } else {
    activeKeyword = null; // Turn off if clicking same button
  }
}

bajakBtn.addEventListener('click', () => {
  handleFilterClick('bajak', bajakBtn);
});

calitBtn.addEventListener('click', () => {
  handleFilterClick('calit', calitBtn);
});

racunBtn.addEventListener('click', () => {
  handleFilterClick('racun', racunBtn);
});

// helper function to update visibility
function updateVisibility() {
  Object.entries(groups).forEach(([group, files]) => {
    (Array.isArray(files) ? files : [files]).forEach(filename => {
      const id = `${group}-${filename}-fill`;
      if (map.getLayer(id)) {
        map.setPaintProperty(id, 'fill-opacity', [
          'case',
          ['==', ['get', '_visible'], true],
          ['interpolate', ['linear'], ['zoom'], 13, 0.4, 16, 0],
          0
        ]);
      }
    });
  });
}

// New added part: set filter logic
let activeButton = null;

function handleButtonClick(type, button) {
  const isActive = activeButton === button;
  clearCheckMarkers();
  resetAllFilterButtons();

  if (!isActive) {
    button.style.color = 'limegreen';
    showCheckmarks(type);
    activeButton = button;
  } else {
    activeButton = null;
  }
}

bajakBtn.addEventListener('click', () => handleButtonClick('bajak', bajakBtn));
calitBtn.addEventListener('click', () => handleButtonClick('calit', calitBtn));
racunBtn.addEventListener('click', () => handleButtonClick('racun', racunBtn));

// --- Filter Logic ---
function clearAllHighlights() {
  Object.entries(groups).forEach(([g, files]) => {
    (Array.isArray(files) ? files : [files]).forEach(file => {
      map.setFilter(`${g}-${file}-highlight`, ['==', '_id', '']);
    });
  });
  document.querySelectorAll('.maplibregl-popup').forEach(p => p.remove());
}

function resetAllFilterButtons() {
  bajakBtn.style.color = 'white';
  calitBtn.style.color = 'white';
  racunBtn.style.color = 'white';
}

function applyWordFilter(word) {
  resetAllFilterButtons();
  clearAllHighlights();

  activeWordFilter = word;

  allFeatures.forEach(f => {
    if (f.properties.description?.toLowerCase().includes(word.toLowerCase())) {
      highlightFeature(f);
    }
  });
}

function applyFilter(type) {
  const buttons = {
    bajak: document.getElementById('filterBajak'),
    calit: document.getElementById('filterCalit'),
    racun: document.getElementById('filterRacun')
  };

  if (currentFilter === type) {
    // Deactivate
    currentFilter = null;
    Object.values(buttons).forEach(btn => btn.style.color = 'white');
  } else {
    // Activate new
    currentFilter = type;
    Object.entries(buttons).forEach(([key, btn]) => {
      btn.style.color = (key === type) ? 'limegreen' : 'white';
    });
  }

  // Apply filter
  Object.entries(groups).forEach(([group, files]) => {
    (Array.isArray(files) ? files : [files]).forEach(filename => {
      const sourceId = `${group}-${filename}`;
      const source = map.getSource(sourceId);
      if (source && source._data) {
        const features = source._data.features.map(f => {
          const desc = (f.properties.description || "").toLowerCase();
          let visible = true;
          if (currentFilter === 'bajak') visible = desc.includes('bajak');
          else if (currentFilter === 'calit') visible = desc.includes('calit');
          else if (currentFilter === 'racun') visible = desc.includes('racun');
          return { ...f, properties: { ...f.properties, _visible: visible } };
        });
        source.setData({ type: 'FeatureCollection', features });
      }
    });
  });
  updateVisibility();
}

function toggleFilter(type) {
  if (activeFilter === type) {
    activeFilter = null;
    setButtonColor();
    resetPolygonFilter();
    return;
  }

  activeFilter = type;
  setButtonColor();
  allFeatures.forEach(f => {
    const desc = f.properties.description ? f.properties.description.toLowerCase() : '';
    const show = (type === 'bajak' && desc.includes('bajak')) ||
                 (type === 'calit' && desc.includes('calit')) ||
                 (type === 'racun' && desc.includes('racun'));
    f.properties._visible = show;
  });
  updateVisiblePolygons();
}

setIconColor();

</script>
</body>
</html>
