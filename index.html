<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Har Padi - Sawah Ring Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    #header {
      position: absolute;
      top: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      text-align: center;
      padding: 10px 0;
      font-family: Helvetica, sans-serif;
      z-index: 1000;
    }

    #header h1 {
      margin: 0;
      font-size: 1.3rem;
    }

    #footer {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      text-align: center;
      font-size: 0.6rem;
      padding: 5px 0;
      font-family: Helvetica, sans-serif;
      z-index: 1000;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    #zoom-info {
      display: none;
      position: absolute;
      bottom: 30px;
      right: 10px;
      background: rgba(0,0,0,0.5);
      color: white;
      font-size: 0.7rem;
      padding: 4px 8px;
      font-family: Helvetica, sans-serif;
      border-radius: 4px;
      z-index: 1000;
    }

    .popup-no-x .maplibregl-popup-close-button {
      display: none;
    }
  </style>
</head>
<body>

  <div id="header">
    <h1>LOT KERJA HAR PADI ENT. (in progress)</h1>
  </div>

  <div id="map"></div>

  <div id="footer">
    Â© 2025 Hisham
  </div>

  <div id="zoom-info">Zoom: 15</div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          'esri-satellite': {
            type: 'raster',
            tiles: [
              'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
            ],
            tileSize: 256,
          }
        },
        layers: [{
          id: 'esri-layer',
          type: 'raster',
          source: 'esri-satellite'
        }]
      },
      center: [102.68379, 2.23708],
      zoom: 15,
      minZoom: 14,
      maxZoom: 17.4
    });

    map.setMaxBounds([
      [102.66954, 2.22235],
      [102.69816, 2.24951]
    ]);

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((pos) => {
        const { latitude, longitude } = pos.coords;
        new maplibregl.Marker({ color: "red" })
          .setLngLat([longitude, latitude])
          .addTo(map);

        map.flyTo({
          center: [longitude, latitude],
          zoom: 17
        });
      });
    }

    map.on('load', () => {
      fetch('sawahring.json')
        .then(res => res.json())
        .then(data => {
          map.addSource('sawahring', {
            type: 'geojson',
            data: data
          });

          map.addLayer({
            id: 'sawahring-fill',
            type: 'fill',
            source: 'sawahring',
            paint: {
              'fill-color': '#00cc66',
              'fill-opacity': 0.4
            }
          });

          map.addLayer({
            id: 'sawahring-outline',
            type: 'line',
            source: 'sawahring',
            paint: {
              'line-color': '#004d26',
              'line-width': 2
            }
          });

          map.addLayer({
            id: 'sawahring-labels',
            type: 'symbol',
            source: 'sawahring',
            layout: {
              'text-field': ['get', 'name'],
              'text-font': ['sans-serif'],
              'text-size': 12,
              'text-offset': [0, 0.6],
              'text-anchor': 'top'
            },
            paint: {
              'text-color': '#000',
              'text-halo-color': '#fff',
              'text-halo-width': 1
            }
          });

          map.addLayer({
            id: 'sawahring-highlight',
            type: 'line',
            source: 'sawahring',
            paint: {
              'line-color': '#ffcc00',
              'line-width': 4
            },
            filter: ['==', 'name', '']
          });

          // On shape click
          map.on('click', 'sawahring-fill', (e) => {
            const feature = e.features[0];
            const name = feature.properties.name;
            const boundsArray = turf.bbox(feature); // [minLng, minLat, maxLng, maxLat]
            const bounds = [
              [boundsArray[0], boundsArray[1]], // southwest
              [boundsArray[2], boundsArray[3]]  // northeast
            ];

            const center = turf.center(feature).geometry.coordinates;

            // Highlight
            map.setFilter('sawahring-highlight', ['==', 'name', name]);

            // Fit bounds with margin and max zoom
            map.fitBounds(bounds, {
              padding: 100,
              maxZoom: 17.4,
              duration: 800
            });

            // Popup in center
            new maplibregl.Popup({ closeButton: false })
              .setLngLat(center)
              .setHTML(`<strong>${name}</strong>`)
              .addTo(map)
              .getElement().classList.add('popup-no-x');
          });

          map.on('mouseenter', 'sawahring-fill', () => {
            map.getCanvas().style.cursor = 'pointer';
          });
          map.on('mouseleave', 'sawahring-fill', () => {
            map.getCanvas().style.cursor = '';
          });
        })
        .catch(err => {
          console.error('Failed to load sawahring.json:', err);
          alert('Could not load map data.');
        });

      map.on('error', (e) => {
        console.error('Map error:', e.error);
      });

      function updateZoomInfo() {
        const zoomLevel = map.getZoom().toFixed(2);
        document.getElementById('zoom-info').textContent = `Zoom: ${zoomLevel}`;
      }

      map.on('zoom', updateZoomInfo);
      updateZoomInfo();
    });
  </script>
</body>
</html>
