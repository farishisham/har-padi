<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Lot Kerja Har Padi Ent.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #header, #footer {
      position: fixed;
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-family: Helvetica, sans-serif;
      text-align: center;
      z-index: 1000;
    }
    #header { top: 0; padding: 6px 0; }
    #header h1 { margin: 0; font-size: 1rem; }
    #footer {
      bottom: 0;
      font-size: 0.6rem;
      padding: 5px 0;
    }
    #map { width: 100%; height: 100%; }
    #gpsButton, #searchButton {
      position: absolute;
      width: 44px; height: 44px;
      background-color: #333;
      border: none; border-radius: 50%;
      z-index: 1001;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #gpsButton { bottom: 5vh; right: 5vw; }
    #searchContainer {
      position: absolute;
      top: 60px;
      right: 5vw;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    #searchInput {
      margin-top: 8px;
      padding: 4px;
      font-size: 0.9rem;
      border-radius: 4px;
      display: none;
    }
    #dropdown {
      margin-top: 4px;
      padding: 4px;
      font-size: 0.9rem;
      display: none;
    }
    .popup-no-x .maplibregl-popup-close-button { display: none; }
  </style>
</head>
<body>
<div id="header"><h1>LOT KERJA HAR PADI ENT. (in progress)</h1></div>
<div id="map"></div>
<div id="footer">Â© 2025 Hisham</div>
<button id="gpsButton" title="Toggle GPS Mode">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="white" xmlns="https://www.w3.org/TR/SVG/">
    <path d="M12 0a1.5 1.5 0 0 1 1.5 1.5V3.1a9.003 9.003..."/>
  </svg>
</button>
<div id="searchContainer">
  <button id="searchButton" title="Search">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="white" xmlns="https://www.w3.org/TR/SVG/">
      <path d="M10 2a8 8 0 1 0 4.9 14.3l5.4 5.4..."/>
    </svg>
  </button>
  <input type="text" id="searchInput" placeholder="Search block name...">
  <select id="dropdown"></select>
</div>
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'esri-satellite': {
          type: 'raster',
          tiles: ['https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
          tileSize: 256,
        }
      },
      layers: [{ id: 'esri-layer', type: 'raster', source: 'esri-satellite' }]
    },
    center: [102.68379, 2.23708],
    zoom: 15,
    minZoom: 14,
    maxZoom: 17.4
  });

  map.setMaxBounds([[102.66830, 2.21776], [102.69816, 2.25551]]);

  let featuresList = [];

  function highlightFeatureByName(name) {
    const feature = featuresList.find(f => f.properties.name === name);
    if (!feature) return;
    const bounds = turf.bbox(feature);
    const center = turf.center(feature).geometry.coordinates;
    map.setFilter('sawahring-highlight', ['==', 'name', name]);
    map.fitBounds([[bounds[0], bounds[1]], [bounds[2], bounds[3]]], { padding: 100, maxZoom: 17.4 });
    new maplibregl.Popup({ closeButton: false })
      .setLngLat(center)
      .setHTML(`<strong>${name}</strong>`)
      .addTo(map)
      .getElement().classList.add('popup-no-x');
  }

  map.on('load', () => {
    fetch('sawahring.json')
      .then(res => res.json())
      .then(data => {
        featuresList = data.features.sort((a, b) => a.properties.name.localeCompare(b.properties.name));

        map.addSource('sawahring', { type: 'geojson', data });
        map.addLayer({ id: 'sawahring-fill', type: 'fill', source: 'sawahring', paint: { 'fill-color': '#00cc66', 'fill-opacity': 0.4 } });
        map.addLayer({ id: 'sawahring-outline', type: 'line', source: 'sawahring', paint: { 'line-color': '#004d26', 'line-width': 2 } });
        map.addLayer({
          id: 'sawahring-labels',
          type: 'symbol',
          source: 'sawahring',
          layout: {
            'text-field': ['get', 'name'],
            'text-font': ['sans-serif'],
            'text-size': 12,
            'text-offset': [0, 0.6],
            'text-anchor': 'top'
          },
          paint: {
            'text-color': '#000',
            'text-halo-color': '#fff',
            'text-halo-width': 1
          }
        });
        map.addLayer({ id: 'sawahring-highlight', type: 'line', source: 'sawahring', paint: { 'line-color': '#ffcc00', 'line-width': 4 }, filter: ['==', 'name', ''] });

        // Populate dropdown
        const dropdown = document.getElementById('dropdown');
        featuresList.forEach(f => {
          const option = document.createElement('option');
          option.value = option.text = f.properties.name;
          dropdown.appendChild(option);
        });
        dropdown.value = "Blok 5";
        dropdown.style.display = 'block';
        highlightFeatureByName("Blok 5");

        dropdown.addEventListener('change', () => {
          highlightFeatureByName(dropdown.value);
        });

        map.on('click', 'sawahring-fill', (e) => {
          const feature = e.features[0];
          highlightFeatureByName(feature.properties.name);
        });
      });
  });

  const searchBtn = document.getElementById("searchButton");
  const searchInput = document.getElementById("searchInput");
  searchBtn.addEventListener("click", () => {
    searchInput.style.display = searchInput.style.display === 'none' ? 'block' : 'none';
    searchInput.focus();
  });
  searchInput.addEventListener("input", () => {
    const query = searchInput.value.toLowerCase();
    const match = featuresList.find(f => f.properties.name.toLowerCase().includes(query));
    if (match) highlightFeatureByName(match.properties.name);
  });
</script>
</body>
</html>
