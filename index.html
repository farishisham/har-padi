<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Lot Kerja Har Padi Ent.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: black;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #header, #footer {
      position: fixed;
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-family: Helvetica, sans-serif;
      text-align: center;
      z-index: 1000;
    }

    #header {
      top: 0;
      padding: 6px 0;
    }

    #header h1 {
      margin: 0;
      font-size: 1rem;
    }

    #footer {
      bottom: 0;
      font-size: 0.6rem;
      padding: 5px 0;
    }

    #gpsButton {
      position: fixed;
      bottom: 35px;
      right: 15px;
      width: 44px;
      height: 44px;
      background-color: #333;
      border: none;
      border-radius: 50%;
      z-index: 1001;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #gpsButton svg {
      width: 20px;
      height: 20px;
    }

    .gps-marker {
      position: relative;
      width: 30px;
      height: 30px;
    }

    .gps-marker .circle {
      width: 13px;
      height: 13px;
      background: #007BFF;
      border: 1px solid white;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
    }

    .gps-marker .triangle {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-bottom: 13px solid white;
      z-index: 1;
    }

    .popup-no-x .maplibregl-popup-close-button {
      display: none;
    }

    .search-container {
      position: absolute;
      top: 44px;
      right: 15px;
      height: 48px;
      z-index: 1003;
    }

    .search-btn, .close-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background-color: #333;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      right: 0;
      z-index: 1002;
      padding: 0;
    }

    .search-btn svg,
    .close-btn svg {
      width: 18px;
      height: 18px;
      fill: white;
    }

    .search-input {
      width: 0;
      opacity: 0;
      padding: 0;
      height: 46px;
      top: -2px;
      transform: translateX(2px);
      border-radius: 30px;
      border: 1px solid #ccc;
      transition: all 0.3s ease;
      background-color: white;
      outline: none;
      padding-left: 10px;
      padding-right: 50px;
      position: absolute;
      right: 0;
      z-index: 1001;
    }

    .search-container.active .search-input {
      width: 200px;
      opacity: 1;
    }

    .search-container.active .search-btn {
      display: none;
    }

    .search-container.active .close-btn {
      display: flex;
    }

    .close-btn {
      display: none;
    }
  </style>
</head>
<body>

<div id="header">
  <h1>LOT KERJA HAR PADI ENT. (in progress)</h1>
</div>

<div id="map"></div>

<div id="footer">
  Â© 2025 Hisham
</div>

<button id="gpsButton" title="Toggle GPS Mode">
  <svg id="gpsIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="white">
    <path d="M 257.14,31.03 A 25,25 0 0 0 231.19,52.88 L 210.72,216.68 A 60,60 0 0 0 196,255.99 a 60,60 0 0 0 20.51,45.11 l 15.24,60.96 a 25,25 0 0 0 48.51,0 l 15.25,-61 a 60,60 0 0 0 20.51,-45.11 60,60 0 0 0 -14.71,-39.25 L 280.81,52.88 A 25,25 0 0 0 257.14,31.03 Z m 50.1,31.74 6.87,54.95 A 150,150 0 0 1 406,255.99 150,150 0 0 1 258.9,405.9 c -0.78,0.05 -1.56,0.07 -2.35,0.08 a 150,150 0 0 1 -0.55,0.02 150,150 0 0 1 -0.27,-0.01 c -1.47,-0.01 -2.93,-0.08 -4.38,-0.22 A 150,150 0 0 1 106,255.99 150,150 0 0 1 197.88,117.87 l 6.87,-54.95 A 200,200 0 0 0 57.71,231.08 a 25,25 0 0 0 -1.71,-0.09 25,25 0 0 0 -25,25 25,25 0 0 0 25,25 25,25 0 0 0 1.75,-0.06 200,200 0 0 0 173.34,173.26 25,25 0 0 0 -0.09,1.81 25,25 0 0 0 25,25 25,25 0 0 0 25,-25 25,25 0 0 0 -0.06,-1.75 200,200 0 0 0 173.25,-173.34 25,25 0 0 0 1.81,0.09 25,25 0 0 0 25,-25 25,25 0 0 0 -25,-25 25,25 0 0 0 -1.76,0.06 200,200 0 0 0 -147,-168.29 Z"/>
  </svg>
</button>

<div class="search-container" id="searchContainer">
  <input type="text" class="search-input" id="searchInput" placeholder="Cari...">
  <button class="search-btn" id="searchBtn" title="Search">
    <svg viewBox="0 0 24 24"><path d="M21.707 20.293l-5.388-5.388A7.935 7.935 0 0018 10a8 8 0 10-8 8 7.935 7.935 0 004.905-1.681l5.388 5.388a1 1 0 001.414-1.414zM4 10a6 6 0 1112 0 6 6 0 01-12 0z"/></svg>
  </button>
  <button class="close-btn" id="closeBtn" title="Tutup">
    <svg viewBox="0 0 24 24"><path d="M18.364 5.636a1 1 0 00-1.414 0L12 10.586 7.05 5.636a1 1 0 00-1.414 1.414L10.586 12l-4.95 4.95a1 1 0 101.414 1.414L12 13.414l4.95 4.95a1 1 0 001.414-1.414L13.414 12l4.95-4.95a1 1 0 000-1.414z"/></svg>
  </button>
</div>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'esri-satellite': {
          type: 'raster',
          tiles: [
            'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
          ],
          tileSize: 256,
        }
      },
      layers: [{
        id: 'esri-layer',
        type: 'raster',
        source: 'esri-satellite'
      }]
    },
    center: [102.68379, 2.23708],
    zoom: 13,
    minZoom: 13,
    maxZoom: 17.4
  });

  map.setMaxBounds([
    [102.66830, 2.21776],
    [102.69816, 2.25551]
  ]);

  let gpsMode = 1;
  let marker = null;
  let watchId = null;
  let lastHeading = null;

  const icon = document.getElementById("gpsIcon");

  function createMarker(lng, lat) {
    const el = document.createElement('div');
    el.className = 'gps-marker';

    const triangle = document.createElement('div');
    triangle.className = 'triangle';

    const circle = document.createElement('div');
    circle.className = 'circle';

    el.appendChild(triangle);
    el.appendChild(circle);

    marker = new maplibregl.Marker(el).setLngLat([lng, lat]).addTo(map);
  }

  function updateMarkerPosition(lng, lat) {
    if (marker) {
      marker.setLngLat([lng, lat]);
    } else {
      createMarker(lng, lat);
    }
  }

  function handleOrientationPermission() {
    if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
      DeviceOrientationEvent.requestPermission()
        .then(response => {
          if (response === "granted") {
            window.addEventListener("deviceorientation", rotateMap, true);
          }
        });
    } else {
      window.addEventListener("deviceorientation", rotateMap, true);
    }
  }

  function rotateMap(event) {
    if (gpsMode !== 3) return;
    let heading = event.webkitCompassHeading !== undefined ? event.webkitCompassHeading : (event.alpha !== null ? 360 - event.alpha : null);
    if (heading !== null && !isNaN(heading)) {
      map.rotateTo(heading, { duration: 200 });
      lastHeading = heading;
    }
  }

  document.getElementById("gpsButton").addEventListener("click", () => {
    gpsMode = (gpsMode % 3) + 1;

    if (watchId) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }

    if (gpsMode === 1) {
      icon.setAttribute("fill", "white");
      return;
    }

    icon.setAttribute("fill", gpsMode === 2 ? "limegreen" : "orange");

    watchId = navigator.geolocation.watchPosition(pos => {
      const lngLat = [pos.coords.longitude, pos.coords.latitude];
      updateMarkerPosition(...lngLat);
      if (gpsMode === 2) {
        map.setCenter(lngLat);
      }
    }, null, { enableHighAccuracy: true });

    if (gpsMode === 3) {
      handleOrientationPermission();
    }
  });

  map.on('dragstart', () => {
    if (gpsMode === 2 || gpsMode === 3) {
      gpsMode = 1;
      icon.setAttribute("fill", "white");
      if (watchId) navigator.geolocation.clearWatch(watchId), watchId = null;
    }
  });

  map.on('load', () => {
    fetch('sawahring.json')
      .then(res => res.json())
      .then(data => {
        map.addSource('sawahring', { type: 'geojson', data });

        map.addLayer({ id: 'sawahring-fill', type: 'fill', source: 'sawahring', paint: { 'fill-color': '#00cc66', 'fill-opacity': 0.4 }});
        map.addLayer({ id: 'sawahring-outline', type: 'line', source: 'sawahring', paint: { 'line-color': '#004d26', 'line-width': 2 }});
        map.addLayer({ id: 'sawahring-labels', type: 'symbol', source: 'sawahring',
          layout: { 'text-field': ['get', 'name'], 'text-font': ['sans-serif'], 'text-size': 12, 'text-offset': [0, 0.6], 'text-anchor': 'top' },
          paint: { 'text-color': '#000', 'text-halo-color': '#fff', 'text-halo-width': 1 }
        });
        map.addLayer({ id: 'sawahring-highlight', type: 'line', source: 'sawahring',
          paint: { 'line-color': '#ffcc00', 'line-width': 4 },
          filter: ['==', 'name', '']
        });

        map.on('click', 'sawahring-fill', e => {
          const feature = e.features[0];
          const name = feature.properties.name;
          const bounds = turf.bbox(feature);
          const center = turf.center(feature).geometry.coordinates;

          gpsMode = 1;
          icon.setAttribute("fill", "white");
          if (watchId) navigator.geolocation.clearWatch(watchId), watchId = null;

          map.setFilter('sawahring-highlight', ['==', 'name', name]);
          map.fitBounds([[bounds[0], bounds[1]], [bounds[2], bounds[3]]], { padding: 100, maxZoom: 17.4 });

          new maplibregl.Popup({ closeButton: false })
            .setLngLat(center)
            .setHTML(`<strong>${name}</strong>`)
            .addTo(map)
            .getElement().classList.add('popup-no-x');
        });

        map.on('click', e => {
          const features = map.queryRenderedFeatures(e.point, { layers: ['sawahring-fill'] });
          if (features.length === 0) {
            map.setFilter('sawahring-highlight', ['==', 'name', '']);
            document.querySelectorAll('.maplibregl-popup').forEach(p => p.remove());
          }
        });
      });
  });

  document.getElementById("searchBtn").addEventListener("click", () => {
    document.getElementById("searchContainer").classList.add("active");
    document.getElementById("searchInput").focus();
  });

  document.getElementById("closeBtn").addEventListener("click", () => {
    document.getElementById("searchContainer").classList.remove("active");
    document.getElementById("searchInput").value = '';
  });
</script>
</body>
</html>
