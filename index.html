<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Lot Kerja Har Padi Ent.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      background: black;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #header, #footer {
      position: fixed;
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-family: Helvetica, sans-serif;
      text-align: center;
      z-index: 1000;
    }

    #header {
      top: 0;
      padding: 6px 0;
    }

    #header h1 {
      margin: 0;
      font-size: 1rem;
    }

    #footer {
      bottom: 0;
      font-size: 0.6rem;
      padding: 5px 0;
    }

    #gpsButton {
      position: fixed;
      bottom: 35px;
      right: 15px;
      width: 44px;
      height: 44px;
      background-color: #333;
      border: none;
      border-radius: 50%;
      z-index: 1001;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #gpsButton svg {
      transition: transform 0.3s ease;
    }

    .gps-marker {
      position: relative;
      width: 24px;
      height: 24px;
    }

    .gps-marker .circle {
      width: 13px;
      height: 13px;
      background: #007BFF;
      border: 1px solid white;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      box-shadow: 0 0 2px #000;
    }

    .gps-marker .gps-arrow {
      position: absolute;
      top: -16px;
      left: 50%;
      transform: translate(-50%, -100%);
      width: 0;
      height: 0;
      border-left: 9px solid transparent;
      border-right: 9px solid transparent;
      border-bottom: 13px solid white;
      z-index: 1;
    }

    .popup-no-x .maplibregl-popup-close-button {
      display: none;
    }
  </style>
</head>
<body>

<div id="header">
  <h1>LOT KERJA HAR PADI ENT. (in progress)</h1>
</div>

<div id="map"></div>

<div id="footer">
  Â© 2025 Hisham
</div>

<button id="gpsButton" title="Toggle GPS Mode">
  <svg id="gpsIcon" width="24" height="24" viewBox="0 0 24 24" fill="white">
    <path d="M12 0a1.5 1.5 0 0 1 1.5 1.5V3.1a9.003 9.003 0 0 1 7.4 7.4h1.6a1.5 1.5 0 0 1 0 3h-1.6a9.003 9.003 0 0 1-7.4 7.4v1.6a1.5 1.5 0 0 1-3 0v-1.6a9.003 9.003 0 0 1-7.4-7.4H1.5a1.5 1.5 0 0 1 0-3H3.1a9.003 9.003 0 0 1 7.4-7.4V1.5A1.5 1.5 0 0 1 12 0Z" />
  </svg>
</button>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<!-- Replace the <script> block below with this updated script -->
<script>
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'esri-satellite': {
          type: 'raster',
          tiles: ['https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
          tileSize: 256
        }
      },
      layers: [{ id: 'esri-layer', type: 'raster', source: 'esri-satellite' }]
    },
    center: [102.68379, 2.23708],
    zoom: 13,
    minZoom: 13,
    maxZoom: 17.4
  });

  map.setMaxBounds([[102.66830, 2.21776], [102.69816, 2.25551]]);

  let gpsMode = 1; // 1 = off, 2 = tracking, 3 = compass
  let marker = null;
  let watchId = null;
  const gpsButton = document.getElementById("gpsButton");
  const gpsIcon = document.getElementById("gpsIcon");

  function createMarker(lng, lat) {
    const el = document.createElement('div');
    el.className = 'gps-marker';

    const arrow = document.createElement('div');
    arrow.className = 'gps-arrow';
    el.appendChild(arrow);

    const circle = document.createElement('div');
    circle.className = 'circle';
    el.appendChild(circle);

    marker = new maplibregl.Marker(el).setLngLat([lng, lat]).addTo(map);
  }

  function updateMarker(lng, lat) {
    if (marker) {
      marker.setLngLat([lng, lat]);
    } else {
      createMarker(lng, lat);
    }
  }

  function rotateMap(event) {
    if (gpsMode !== 3) return;
    let heading = event.webkitCompassHeading !== undefined ? event.webkitCompassHeading : 360 - event.alpha;
    if (heading && !isNaN(heading)) {
      map.easeTo({ bearing: heading, duration: 300 });
    }
  }

  function stopCompass() {
    window.removeEventListener('deviceorientation', rotateMap);
  }

  function startTracking(compass = false) {
    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude } = pos.coords;
      updateMarker(longitude, latitude);
      map.panTo([longitude, latitude]); // Only pan, no zoom
    }, console.error, { enableHighAccuracy: true });

    if (compass) {
      if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(response => {
          if (response === 'granted') window.addEventListener('deviceorientation', rotateMap);
        });
      } else {
        window.addEventListener('deviceorientation', rotateMap);
      }
    }
  }

  gpsButton.addEventListener("click", () => {
    gpsMode = (gpsMode % 3) + 1;

    // Keep button background dark grey
    gpsButton.style.backgroundColor = "#333";

    if (gpsMode === 1) {
      gpsIcon.setAttribute("fill", "white");
      if (watchId) navigator.geolocation.clearWatch(watchId);
      stopCompass();
    } else if (gpsMode === 2) {
      gpsIcon.setAttribute("fill", "limegreen");
      stopCompass();
      startTracking(false);
    } else if (gpsMode === 3) {
      gpsIcon.setAttribute("fill", "orange");
      startTracking(true);
    }
  });

  map.on('load', () => {
    fetch('sawahring.json').then(res => res.json()).then(data => {
      map.addSource('sawahring', { type: 'geojson', data });

      map.addLayer({ id: 'sawahring-fill', type: 'fill', source: 'sawahring', paint: { 'fill-color': '#00cc66', 'fill-opacity': 0.4 } });
      map.addLayer({ id: 'sawahring-outline', type: 'line', source: 'sawahring', paint: { 'line-color': '#004d26', 'line-width': 2 } });
      map.addLayer({
        id: 'sawahring-labels',
        type: 'symbol',
        source: 'sawahring',
        layout: { 'text-field': ['get', 'name'], 'text-font': ['sans-serif'], 'text-size': 12, 'text-offset': [0, 0.6], 'text-anchor': 'top' },
        paint: { 'text-color': '#000', 'text-halo-color': '#fff', 'text-halo-width': 1 }
      });
      map.addLayer({ id: 'sawahring-highlight', type: 'line', source: 'sawahring', paint: { 'line-color': '#ffcc00', 'line-width': 4 }, filter: ['==', 'name', ''] });

      map.on('click', 'sawahring-fill', (e) => {
        const feature = e.features[0];
        const name = feature.properties.name;
        const bounds = turf.bbox(feature);
        const center = turf.center(feature).geometry.coordinates;

        gpsMode = 1;
        gpsIcon.setAttribute("fill", "white");
        if (watchId) navigator.geolocation.clearWatch(watchId);
        stopCompass();

        map.setFilter('sawahring-highlight', ['==', 'name', name]);
        map.fitBounds([[bounds[0], bounds[1]], [bounds[2], bounds[3]]], { padding: 100, maxZoom: 17.4 });

        new maplibregl.Popup({ closeButton: false })
          .setLngLat(center)
          .setHTML(`<strong>${name}</strong>`)
          .addTo(map)
          .getElement().classList.add('popup-no-x');
      });

      map.on('click', e => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['sawahring-fill'] });
        if (!features.length) {
          map.setFilter('sawahring-highlight', ['==', 'name', '']);
          document.querySelectorAll('.maplibregl-popup').forEach(p => p.remove());
        }
      });
    });
  });

  document.getElementById("searchBtn").addEventListener("click", () => {
    document.getElementById("searchContainer").classList.add("active");
    document.getElementById("searchInput").focus();
  });

  document.getElementById("closeBtn").addEventListener("click", () => {
    document.getElementById("searchContainer").classList.remove("active");
    document.getElementById("searchInput").value = '';
  });
</script>

</body>
</html>
