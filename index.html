<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Lot Kerja Har Padi Ent.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      background: black;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #header, #footer {
      position: fixed;
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-family: Helvetica, sans-serif;
      text-align: center;
      z-index: 1000;
    }

    #header {
      top: 0;
      padding: 6px 0;
    }

    #header h1 {
      margin: 0;
      font-size: 1rem;
    }

    #footer {
      bottom: 0;
      font-size: 0.6rem;
      padding: 5px 0;
    }

    #gpsButton {
      position: fixed;
      bottom: 35px;
      right: 15px;
      width: 44px;
      height: 44px;
      background-color: #333;
      border: none;
      border-radius: 50%;
      z-index: 1001;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #gpsButton svg {
      transition: transform 0.3s ease;
    }

    .gps-marker {
      position: relative;
      width: 24px;
      height: 24px;
    }

    .gps-marker .circle {
      width: 13px;
      height: 13px;
      background: #007BFF;
      border: 1px solid white;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      box-shadow: 0 0 2px #000;
    }

    .gps-marker .gps-arrow {
      position: absolute;
      top: -16px;
      left: 50%;
      transform: translate(-50%, -100%);
      width: 0;
      height: 0;
      border-left: 9px solid transparent;
      border-right: 9px solid transparent;
      border-bottom: 13px solid white;
      z-index: 1;
    }

    .popup-no-x .maplibregl-popup-close-button {
      display: none;
    }
  </style>
</head>
<body>

<div id="header">
  <h1>LOT KERJA HAR PADI ENT. (in progress)</h1>
</div>

<div id="map"></div>

<div id="footer">
  Â© 2025 Hisham
</div>

<button id="gpsButton" title="Toggle GPS Mode">
  <svg id="gpsIcon" width="24" height="24" viewBox="0 0 24 24" fill="white">
    <path d="M12 0a1.5 1.5 0 0 1 1.5 1.5V3.1a9.003 9.003 0 0 1 7.4 7.4h1.6a1.5 1.5 0 0 1 0 3h-1.6a9.003 9.003 0 0 1-7.4 7.4v1.6a1.5 1.5 0 0 1-3 0v-1.6a9.003 9.003 0 0 1-7.4-7.4H1.5a1.5 1.5 0 0 1 0-3H3.1a9.003 9.003 0 0 1 7.4-7.4V1.5A1.5 1.5 0 0 1 12 0Z" />
  </svg>
</button>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'esri-satellite': {
          type: 'raster',
          tiles: ['https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
          tileSize: 256,
        }
      },
      layers: [{
        id: 'esri-layer',
        type: 'raster',
        source: 'esri-satellite'
      }]
    },
    center: [102.68379, 2.23708],
    zoom: 13,
    minZoom: 13,
    maxZoom: 17.4
  });

  map.setMaxBounds([[102.66830, 2.21776], [102.69816, 2.25551]]);

  let gpsMode = 1;
  let watchId = null;
  let marker = null;
  let lastHeading = null;
  const icon = document.getElementById('gpsIcon');

  function createMarker(lng, lat) {
    const el = document.createElement('div');
    el.className = 'gps-marker';

    const circle = document.createElement('div');
    circle.className = 'circle';

    const arrowEl = document.createElement('div');
    arrowEl.className = 'gps-arrow';

    el.appendChild(arrowEl);
    el.appendChild(circle);

    marker = new maplibregl.Marker(el).setLngLat([lng, lat]).addTo(map);
  }

  function updateMarkerPosition(lng, lat) {
    if (marker) {
      marker.setLngLat([lng, lat]);
    } else {
      createMarker(lng, lat);
    }
  }

  function rotateMap(event) {
    let heading = event.webkitCompassHeading !== undefined
      ? event.webkitCompassHeading
      : event.alpha !== null
      ? 360 - event.alpha
      : null;

    if (heading !== null && !isNaN(heading)) {
      if (lastHeading === null || Math.abs(heading - lastHeading) > 1) {
        map.easeTo({ bearing: heading, duration: 300 });
        lastHeading = heading;
      }
    }
  }

  function handleOrientationPermission() {
    if (typeof DeviceOrientationEvent !== "undefined" &&
        typeof DeviceOrientationEvent.requestPermission === "function") {
      DeviceOrientationEvent.requestPermission().then(response => {
        if (response === "granted") {
          window.addEventListener("deviceorientation", rotateMap, true);
        }
      }).catch(console.error);
    } else {
      window.addEventListener("deviceorientation", rotateMap, true);
    }
  }

  function stopOrientationTracking() {
    window.removeEventListener("deviceorientation", rotateMap, true);
    map.rotateTo(0); // reset map bearing
    lastHeading = null;
  }

  function startTrackingWithCompass() {
    watchId = navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude } = pos.coords;
      updateMarkerPosition(longitude, latitude);
      map.flyTo({ center: [longitude, latitude], zoom: 16 });
    }, err => {
      console.error("Geolocation error:", err);
      alert("Could not access your location.");
    }, { enableHighAccuracy: true });

    handleOrientationPermission();
  }

  function stopGPS() {
    if (watchId) navigator.geolocation.clearWatch(watchId);
    stopOrientationTracking();
    watchId = null;
  }

  document.getElementById('gpsButton').addEventListener('click', () => {
    gpsMode = (gpsMode + 1) % 3;

    if (gpsMode === 0) {
      icon.setAttribute("fill", "white");
      stopGPS();
    } else if (gpsMode === 1) {
      icon.setAttribute("fill", "limegreen");
      stopOrientationTracking();
      watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude } = pos.coords;
        updateMarkerPosition(longitude, latitude);
        map.flyTo({ center: [longitude, latitude], zoom: 16 });
      }, null, { enableHighAccuracy: true });
    } else if (gpsMode === 2) {
      icon.setAttribute("fill", "deepskyblue");
      startTrackingWithCompass();
    }
  });
</script>
</body>
</html>
