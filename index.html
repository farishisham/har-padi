<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Lot Kerja Har Padi Ent.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background: black; }
    #map { width: 100%; height: 100%; }
    #header, #footer {
      position: fixed;
      width: 100%;
      background: transparent;
      color: white;
      font-family: Helvetica, sans-serif;
      text-align: center;
      z-index: 1000;
      text-shadow: 0 0 3px black;
    }
    #header { top: 0; padding: 6px 0; }
    #header h1 { margin: 0; font-size: 0.9rem; }
    #footer { bottom: 0; font-size: 0.6rem; padding: 5px 10px; text-align: left; }

    #gpsButton {
      position: fixed; bottom: 35px; right: 15px;
      width: 44px; height: 44px; background: #333;
      border: none; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 1001;
    }
    #gpsIconImg { width: 20px; height: 20px; }

    .gps-marker {
      position: relative; width: 30px; height: 30px;
    }
    .gps-marker .circle {
      width: 13px; height: 13px; background: #007BFF;
      border: 1px solid white; border-radius: 50%;
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%,-50%); z-index: 2;
    }
    .gps-marker .triangle {
      position: absolute; top: 0; left: 50%;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 7px solid transparent;
      border-right: 7px solid transparent;
      border-bottom: 13px solid white;
      z-index: 1;
    }

    .popup-no-x .maplibregl-popup-close-button { display: none; }

    .search-container {
      position: absolute; top: 44px; right: 15px; height: 48px; z-index: 1003;
    }
    .search-btn, .close-btn {
      position: absolute; right: 0; z-index: 1002;
      width: 44px; height: 44px; padding: 0;
      border: none; border-radius: 50%;
      background: #333; display: flex;
      align-items: center; justify-content: center;
      cursor: pointer;
    }
    .search-btn svg, .close-btn svg { width: 18px; height: 18px; fill: white; }
    .search-input {
      position: absolute; right: 0; z-index: 1001;
      width: 0; opacity: 0; height: 41px; top: -2px;
      transform: translateX(2px); padding-left: 10px; padding-right: 50px;
      border-radius: 30px; border: 1px solid #ccc;
      background: white; outline: none;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    .search-container.active .search-input {
      width: 200px; opacity: 1;
    }
    .search-container.active .search-btn { display: none; }
    .search-container.active .close-btn { display: flex; }
    .close-btn { display: none; }

    /* Suggestion Box */
    #suggestions {
      position: absolute;
      top: 90px;
      right: 83px;
      width: 190px;
      max-height: 150px;
      overflow-y: auto;
      background: white;
      border-radius: 5px;
      font-family: Helvetica, sans-serif;
      font-size: 0.8rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1002;
      display: none;
    }
    #suggestions div {
      padding: 8px 10px;
      cursor: pointer;
    }
    #suggestions div:hover {
      background: #eee;
    }

    /* Message Box */
    #messageBox {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 8px 16px;
      border-radius: 5px;
      font-family: Helvetica, sans-serif;
      font-size: 0.85rem;
      z-index: 1005;
      display: none;
    }
  </style>
</head>
<body>

<div id="header"><h1>LOT KERJA HAR PADI ENT. (in progress)</h1></div>
<div id="map"></div>
<div id="footer">Â© 2025 Hisham</div>

<button id="gpsButton" title="Toggle GPS Mode">
  <img id="gpsIconImg" src="https://www.svgrepo.com/download/421169/gps-navigation-position.svg" alt="GPS">
</button>

<div class="search-container" id="searchContainer">
  <input type="text" class="search-input" id="searchInput" placeholder="Cari...">
  <button class="search-btn" id="searchBtn" title="Search">
    <svg viewBox="0 0 24 24"><path d="M21.707 20.293l-5.388-5.388A7.935 7.935 0 0018 10a8 8 0 10-8 8 7.935 7.935 0 004.905-1.681l5.388 5.388a1 1 0 001.414-1.414zM4 10a6 6 0 1112 0 6 6 0 01-12 0z"></path></svg>
  </button>
  <button class="close-btn" id="closeBtn" title="Tutup">
    <svg viewBox="0 0 24 24"><path d="M18.364 5.636a1 1 0 00-1.414 0L12 10.586 7.05 5.636a1 1 0 00-1.414 1.414L10.586 12l-4.95 4.95a1 1 0 101.414 1.414L12 13.414l4.95 4.95a1 1 0 001.414-1.414L13.414 12l4.95-4.95a1 1 0 000-1.414z"></path></svg>
  </button>
</div>

<div id="suggestions"></div>
<div id="messageBox"></div>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>
const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      'esri-satellite': {
        type: 'raster',
        tiles: ['https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
        tileSize: 256
      }
    },
    layers: [{
      id: 'esri-layer',
      type: 'raster',
      source: 'esri-satellite'
    }]
  },
  center: [102.68379, 2.23708],
  zoom: 13,
  minZoom: 13,
  maxZoom: 17.4,
  maxBounds: [
    [102.66830, 2.21776],
    [102.69816, 2.25551]
  ]
});

let gpsMode = 1;
let watchId = null;
let marker = null;
const iconImg = document.getElementById('gpsIconImg');
const messageBox = document.getElementById('messageBox');

function setIconColor() {
  iconImg.style.filter =
    gpsMode === 1 ? 'invert(100%)' :
    gpsMode === 2 ? 'invert(67%) sepia(92%) saturate(455%) hue-rotate(81deg)' :
    'invert(43%) sepia(100%) saturate(8000%) hue-rotate(1deg)';
}

function showMessage(text) {
  messageBox.textContent = text;
  messageBox.style.display = 'block';
  setTimeout(() => {
    messageBox.style.display = 'none';
  }, 3000);
}

function createMarker(lng, lat) {
  const el = document.createElement('div');
  el.className = 'gps-marker';
  const triangle = document.createElement('div');
  triangle.className = 'triangle';
  const circle = document.createElement('div');
  circle.className = 'circle';
  el.appendChild(triangle);
  el.appendChild(circle);
  marker = new maplibregl.Marker(el).setLngLat([lng, lat]).addTo(map);
}

function updateMarker(lng, lat) {
  if (marker) {
    marker.setLngLat([lng, lat]);
  } else {
    createMarker(lng, lat);
  }
}

function handleOrientation() {
  if (DeviceOrientationEvent.requestPermission) {
    DeviceOrientationEvent.requestPermission().then(r => {
      if (r === 'granted') {
        window.addEventListener('deviceorientation', rotateMap, true);
      }
    });
  } else {
    window.addEventListener('deviceorientation', rotateMap, true);
  }
}

function rotateMap(e) {
  if (gpsMode !== 3) return;
  const heading = e.webkitCompassHeading !== undefined ? e.webkitCompassHeading : (360 - e.alpha);
  if (heading && !isNaN(heading)) {
    map.rotateTo(heading, { duration: 100 });
  }
}

document.getElementById('gpsButton').addEventListener('click', () => {
  map.dragPan.enable();
  map.scrollZoom.enable();
  map.touchZoomRotate.enable();

  gpsMode = (gpsMode % 3) + 1;
  setIconColor();

  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  window.removeEventListener('deviceorientation', rotateMap);

  if (gpsMode === 1) return;

  watchId = navigator.geolocation.watchPosition(pos => {
    const lng = pos.coords.longitude;
    const lat = pos.coords.latitude;

    // Check if outside bounds
    const bounds = map.getMaxBounds();
    if (lng < bounds.getWest() || lng > bounds.getEast() || lat < bounds.getSouth() || lat > bounds.getNorth()) {
      showMessage('Anda berada di luar kawasan..');
      gpsMode = 1;
      setIconColor();
      if (watchId) navigator.geolocation.clearWatch(watchId);
      watchId = null;
      return;
    }

    updateMarker(lng, lat);
    if (gpsMode === 2) {
      map.setCenter([lng, lat]);
    }
  }, null, { enableHighAccuracy: true });

  if (gpsMode === 3) {
    handleOrientation();
  }
});

// Cancel GPS when user touches map
map.on('dragstart', () => {
  if (gpsMode !== 1) {
    gpsMode = 1;
    setIconColor();
    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = null;
    window.removeEventListener('deviceorientation', rotateMap);
  }
});

// Load polygons
const allFeatures = [];
let currentPopup = null;

map.on('load', () => {
  Promise.all([
    fetch('sawahring.json').then(r => r.json()),
    fetch('blok1.json').then(r => r.json()),
    fetch('blok5.json').then(r => r.json())
  ]).then(([sawahring, blok1, blok5]) => {

    addGroup('sawahring', sawahring, 'sawahring');
    addGroup('blok1', blok1, 'blok');
    addGroup('blok5', blok5, 'blok');

    updateSearchList();
  });
});

function addGroup(sourceId, data, group) {
  map.addSource(sourceId, { type: 'geojson', data: data });

  const baseOpacity = group === 'sawahring' ? 0.4 : 0;
  map.addLayer({
    id: `${sourceId}-fill`,
    type: 'fill',
    source: sourceId,
    paint: {
      'fill-color': ['get', 'fill'],
      'fill-opacity': [
        'interpolate', ['linear'], ['zoom'],
        14, baseOpacity,
        16, baseOpacity === 0.4 ? 0 : 0.4
      ]
    }
  });

  map.addLayer({
    id: `${sourceId}-outline`,
    type: 'line',
    source: sourceId,
    paint: {
      'line-color': '#ffcc00',
      'line-width': 2
    }
  });

  map.on('click', `${sourceId}-fill`, e => {
    const feature = e.features[0];
    selectFeature(feature);
  });

  allFeatures.push(...data.features.map(f => ({
    name: f.properties.name,
    group: group,
    id: f.properties.id,
    sourceId: sourceId,
    geometry: f.geometry
  })));
}

function selectFeature(feature) {
  gpsMode = 1;
  setIconColor();
  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  window.removeEventListener('deviceorientation', rotateMap);

  if (currentPopup) {
    currentPopup.remove();
    currentPopup = null;
  }

  const bounds = turf.bbox(feature);
  const center = turf.center(feature).geometry.coordinates;
  map.fitBounds([[bounds[0], bounds[1]], [bounds[2], bounds[3]]], { padding: 100, maxZoom: 17.4, bearing: map.getBearing() });

  currentPopup = new maplibregl.Popup({ closeButton: false })
    .setLngLat(center)
    .setHTML(`<strong>${feature.properties.name}</strong>`)
    .addTo(map)
    .getElement().classList.add('popup-no-x');
}

// Search
const searchInput = document.getElementById('searchInput');
const suggestions = document.getElementById('suggestions');

function updateSearchList() {
  searchInput.addEventListener('input', () => {
    const value = searchInput.value.trim().toLowerCase();
    suggestions.innerHTML = '';

    if (value.length === 0) {
      suggestions.style.display = 'none';
      return;
    }

    const filtered = allFeatures.filter(f => f.name.toLowerCase().includes(value));

    filtered.forEach(f => {
      const div = document.createElement('div');
      div.textContent = f.name;
      div.addEventListener('click', () => {
        suggestions.style.display = 'none';
        searchInput.value = '';

        const feature = {
          properties: { name: f.name },
          geometry: f.geometry
        };
        selectFeature(feature);
      });
      suggestions.appendChild(div);
    });

    if (filtered.length > 0) {
      suggestions.style.display = 'block';
    } else {
      suggestions.style.display = 'none';
    }
  });
}

document.getElementById('searchBtn').addEventListener('click', () => {
  document.getElementById('searchContainer').classList.add('active');
  searchInput.focus();
});

document.getElementById('closeBtn').addEventListener('click', () => {
  document.getElementById('searchContainer').classList.remove('active');
  searchInput.value = '';
  suggestions.style.display = 'none';
});
</script>


</body>
</html>
